# ============================================
# GitHub Actions CI/CD å·¥ä½œæµé…ç½®æ–‡ä»¶
# ============================================
#
# è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†æŒç»­é›†æˆ (CI) å’ŒæŒç»­éƒ¨ç½² (CD) çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚
# å½“ä»£ç æ¨é€åˆ°ä»“åº“æ—¶ï¼ŒGitHub Actions ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚
#
# æ–‡ä»¶ä½ç½®ï¼š.github/workflows/ci.yml
# GitHub ä¼šè‡ªåŠ¨æ£€æµ‹è¿™ä¸ªç›®å½•ä¸‹çš„ YAML æ–‡ä»¶å¹¶æ‰§è¡Œå·¥ä½œæµ

# å·¥ä½œæµåç§° - ä¼šæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢
name: CI/CD Pipeline

# ============================================
# è§¦å‘æ¡ä»¶ (on)
# å®šä¹‰ä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘è¿™ä¸ªå·¥ä½œæµ
# ============================================
on:
  # æ¨é€åˆ°ä»¥ä¸‹åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches:
      - main      # ä¸»åˆ†æ”¯
      - develop   # å¼€å‘åˆ†æ”¯
  
  # Pull Request åˆå¹¶åˆ°ä»¥ä¸‹åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches:
      - main
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  # åœ¨ GitHub Actions é¡µé¢å¯ä»¥çœ‹åˆ° "Run workflow" æŒ‰é’®
  workflow_dispatch:

# ============================================
# ä½œä¸šå®šä¹‰ (jobs)
# ä¸€ä¸ªå·¥ä½œæµå¯ä»¥åŒ…å«å¤šä¸ªä½œä¸šï¼Œä½œä¸šå¯ä»¥å¹¶è¡Œæˆ–ä¸²è¡Œæ‰§è¡Œ
# ============================================
jobs:
  
  # ------------------------------------------
  # ä½œä¸š 1: ä»£ç æ£€æŸ¥ (Lint)
  # ------------------------------------------
  lint:
    # ä½œä¸šåç§°ï¼Œæ˜¾ç¤ºåœ¨ GitHub Actions UI ä¸­
    name: ä»£ç é£æ ¼æ£€æŸ¥
    
    # è¿è¡Œç¯å¢ƒ - ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç³»ç»Ÿ
    runs-on: ubuntu-latest
    
    # ä½œä¸šæ­¥éª¤
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      # actions/checkout æ˜¯ GitHub å®˜æ–¹æä¾›çš„åŠ¨ä½œ
      # å®ƒä¼šå°†ä»“åº“ä»£ç å…‹éš†åˆ°è¿è¡Œå™¨ä¸Š
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # æ­¥éª¤ 2: å®‰è£… uv
      # astral-sh/setup-uv æ˜¯ uv å®˜æ–¹æä¾›çš„ GitHub Action
      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v4
        with:
          # å¯ç”¨ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
          enable-cache: true
      
      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        run: uv python install 3.12
      
      # æ­¥éª¤ 4: å®‰è£…ä¾èµ–
      # --dev ä¼šåŒæ—¶å®‰è£…å¼€å‘ä¾èµ–ï¼ˆåŒ…æ‹¬ ruffï¼‰
      - name: å®‰è£…ä¾èµ–
        run: uv sync --dev
      
      # æ­¥éª¤ 5: è¿è¡Œä»£ç æ£€æŸ¥
      # ruff check: æ£€æŸ¥ä»£ç é£æ ¼å’Œæ½œåœ¨é—®é¢˜
      # ruff format --check: æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆä¸ä¿®æ”¹æ–‡ä»¶ï¼‰
      - name: è¿è¡Œ Ruff ä»£ç æ£€æŸ¥
        run: |
          uv run ruff check src/ tests/
          uv run ruff format --check src/ tests/

  # ------------------------------------------
  # ä½œä¸š 2: æµ‹è¯• (Test)
  # ------------------------------------------
  test:
    # ä½œä¸šåç§°
    name: è¿è¡Œæµ‹è¯•
    
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # ä¾èµ–å…³ç³» - ç­‰å¾… lint ä½œä¸šå®Œæˆåå†æ‰§è¡Œ
    # è¿™æ„å‘³ç€å¦‚æœä»£ç æ£€æŸ¥å¤±è´¥ï¼Œæµ‹è¯•ä¸ä¼šè¿è¡Œ
    needs: lint
    
    # çŸ©é˜µç­–ç•¥ - åœ¨å¤šä¸ª Python ç‰ˆæœ¬ä¸Šæµ‹è¯•
    # ç¡®ä¿ä»£ç åœ¨ä¸åŒç‰ˆæœ¬çš„ Python ä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œ
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      
      # ä½¿ç”¨çŸ©é˜µä¸­çš„ Python ç‰ˆæœ¬
      - name: è®¾ç½® Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}
      
      - name: å®‰è£…ä¾èµ–
        run: uv sync --dev
      
      # è¿è¡Œ pytest æµ‹è¯•
      # -v: è¯¦ç»†è¾“å‡º
      # --tb=short: ç®€çŸ­çš„é”™è¯¯è¿½è¸ªä¿¡æ¯
      - name: è¿è¡Œæµ‹è¯•
        run: uv run pytest -v --tb=short

  # ------------------------------------------
  # ä½œä¸š 3: æ„å»ºéªŒè¯ (Build)
  # ------------------------------------------
  build:
    name: æ„å»ºéªŒè¯
    runs-on: ubuntu-latest
    
    # ç­‰å¾…æµ‹è¯•é€šè¿‡
    needs: test
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      
      - name: è®¾ç½® Python
        run: uv python install 3.12
      
      - name: å®‰è£…ä¾èµ–
        run: uv sync
      
      # éªŒè¯åº”ç”¨å¯ä»¥æ­£å¸¸å¯¼å…¥
      # è¿™ç¡®ä¿æ²¡æœ‰å¯¼å…¥é”™è¯¯æˆ–è¯­æ³•é”™è¯¯
      - name: éªŒè¯åº”ç”¨å¯ä»¥å¯åŠ¨
        run: |
          uv run python -c "from src.app.main import app; print('åº”ç”¨å¯¼å…¥æˆåŠŸï¼')"
      
      # æ„å»º Python åŒ…
      # è¿™ä¼šåˆ›å»º wheel å’Œ sdist åˆ†å‘åŒ…
      - name: æ„å»ºåŒ…
        run: uv build
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      # å¯ä»¥åœ¨ Actions é¡µé¢ä¸‹è½½è¿™äº›æ–‡ä»¶
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          # ä¿ç•™ 7 å¤©
          retention-days: 7

  # ------------------------------------------
  # ä½œä¸š 4: éƒ¨ç½² (Deploy) - ä»…åœ¨ä¸»åˆ†æ”¯
  # ------------------------------------------
  deploy:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # ç­‰å¾…æ„å»ºå®Œæˆ
    needs: build
    
    # æ¡ä»¶æ‰§è¡Œ - åªåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œ
    # github.ref == 'refs/heads/main' æ£€æŸ¥å½“å‰åˆ†æ”¯
    # github.event_name == 'push' ç¡®ä¿æ˜¯æ¨é€äº‹ä»¶ï¼ˆä¸æ˜¯ PRï¼‰
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    # ç¯å¢ƒé…ç½® - å¯ä»¥åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®
    # æ”¯æŒä¿æŠ¤è§„åˆ™ï¼ˆå¦‚éœ€è¦å®¡æ‰¹ï¼‰å’Œç¯å¢ƒç§˜å¯†
    environment:
      name: production
      # éƒ¨ç½²åçš„åº”ç”¨ URLï¼ˆç¤ºä¾‹ï¼‰
      url: https://your-app-url.com
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # ä¸‹è½½ä¹‹å‰æ„å»ºçš„äº§ç‰©
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      
      # è¿™é‡Œæ˜¯å®é™…çš„éƒ¨ç½²æ­¥éª¤
      # æ ¹æ®ä½ çš„éƒ¨ç½²ç›®æ ‡ï¼ˆå¦‚ Herokuã€AWSã€Azure ç­‰ï¼‰ï¼Œ
      # æ›¿æ¢ä¸ºç›¸åº”çš„éƒ¨ç½²å‘½ä»¤
      - name: éƒ¨ç½²åº”ç”¨
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "æ„å»ºäº§ç‰©:"
          ls -la dist/
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          # 
          # å®é™…éƒ¨ç½²ç¤ºä¾‹ï¼ˆå–æ¶ˆæ³¨é‡Šå¹¶é…ç½®ï¼‰ï¼š
          #
          # éƒ¨ç½²åˆ° Heroku:
          # heroku container:push web --app your-app-name
          # heroku container:release web --app your-app-name
          #
          # éƒ¨ç½²åˆ° AWS ECS:
          # aws ecs update-service --cluster your-cluster --service your-service --force-new-deployment
          #
          # éƒ¨ç½²åˆ° Docker Hub:
          # docker build -t your-image:${{ github.sha }} .
          # docker push your-image:${{ github.sha }}

# ============================================
# å·¥ä½œæµè¯´æ˜
# ============================================
#
# è¿™ä¸ª CI/CD æµç¨‹åŒ…å« 4 ä¸ªé˜¶æ®µï¼š
#
# 1. ä»£ç æ£€æŸ¥ (lint)
#    - ä½¿ç”¨ Ruff æ£€æŸ¥ä»£ç é£æ ¼
#    - ç¡®ä¿ä»£ç ç¬¦åˆ Python æœ€ä½³å®è·µ
#
# 2. æµ‹è¯• (test)
#    - åœ¨å¤šä¸ª Python ç‰ˆæœ¬ä¸Šè¿è¡Œæµ‹è¯•
#    - ä¾èµ– lint é˜¶æ®µé€šè¿‡
#
# 3. æ„å»º (build)
#    - éªŒè¯åº”ç”¨å¯ä»¥æ­£å¸¸å¯¼å…¥
#    - æ„å»º Python åˆ†å‘åŒ…
#    - ä¸Šä¼ æ„å»ºäº§ç‰©
#
# 4. éƒ¨ç½² (deploy)
#    - ä»…åœ¨ main åˆ†æ”¯ä¸Šæ‰§è¡Œ
#    - ä¸‹è½½æ„å»ºäº§ç‰©å¹¶éƒ¨ç½²
#
# å·¥ä½œæµæ‰§è¡Œé¡ºåºï¼š
# lint â†’ test â†’ build â†’ deploy
#
# å¦‚æœä»»ä½•é˜¶æ®µå¤±è´¥ï¼Œåç»­é˜¶æ®µä¸ä¼šæ‰§è¡Œ
